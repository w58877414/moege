<?php/** * Created by PhpStorm. * User: 78742 * Date: 2017/2/11 0011 * Time: 15:48 */namespace moe\controller;require_once 'moe_core/Controller.php';class Moem extends \moe\core\Controller{    /**     * @var \moe\model\MoeModel     */    public $model;    private $title = '格萌网手机端';    private $data;    public function __construct()    {        parent::__construct('MoeModel','Moem');        session_start();        if (count($_POST) > 0){            $_POST = $this->form_arr_filter($_POST)?:$this->error_back('存在非法字符！');        }        $ginfo = $_GET['v'];        if(empty($_GET['v'])){            $this->data['typelist'] = $this->model->typeAll();        }    }    public function login()    {        if(!empty($_SESSION['m_id'])){            $this->succeed_href('登陆成功','./?m=Moem');        }        $data['title'] = '用户登陆-'.$this->title;        $this->useView('login',$data);    }    public function logging()    {        $username = $_POST['username']?: $this->error_back('非法访问');        $pass = $_POST['password'];        $salt = $this->model->login_username($username)?: $this->error_back($this->gset['user_nosearch']);        $info = $this->model->logging($username, $pass, $salt);        if($info){            $_SESSION['m_id'] = $info['m_id'];            $_SESSION['m_name'] = $info['m_name'];            $_SESSION['m_nickname'] = $info['m_nickname'];            $_SESSION['m_head'] = $info['m_head'];            $this->succeed_href('登陆成功','./?m=Moem');        }else{            $this->error_back('密码不正确');        }    }    public function logout()    {        if(session_destroy()){            $this->succeed_href('注销登陆成功','?m=Moem&v=login');        }else {            $this->error_back('注销登陆失败');        }    }    public function signup()    {        $data['title'] = '用户注册-'.$this->title;        $this->useView('signup',$data);    }    public function signuping()    {        $nickname = $_POST['nickname']?: $this->error_back('非法访问');        $username = $_POST['username'];        $pass = $_POST['password1'];        $this->form_str_username($username)?: $this->error_back($this->gset['user_err']);        $this->model->member_name_same($username)===0 ? : $this->error_back($this->gset['user_same']);        $this->form_str_password($pass)?: $this->error_back($this->gset['pass_err']);        (strcasecmp($_SESSION['imgcode'], $_POST['imgcode'])==0)?: $this->error_back('验证码不正确');        if($this->model->signup($nickname, $username, $pass)){            $_SESSION['imgcode'] = '';            $salt = $this->model->login_username($username)?: $this->error_back($this->gset['user_nosearch']);            $info = $this->model->logging($username, $pass, $salt);            $_SESSION['m_id'] = $info['m_id'];            $_SESSION['m_name'] = $info['m_name'];            $_SESSION['m_nickname'] = $info['m_nickname'];            $_SESSION['m_head'] = $info['m_head'];            $this->succeed_href('注册成功','?m=Moem');        }else{            $this->error_back('注册失败');        }    }    public function imgCode()    {        require_once 'moe_core/imgCode.php';        $imgCode = new \moe\core\imgCode(120, 36, 18, 'imgcode');        $imgCode->getImg();    }    public function index()    {        $data = $this->data;        $p = $_GET['p'] ? $_GET['p'] : 1;        $order = $_GET['o'] ? $_GET['o'] : null;        $tid = $_GET['tid'] ? $_GET['tid'] : null;        $tyid = $_GET['tyid'] ? $_GET['tyid'] : null;        $search = $_GET['search']? $_GET['search'] : null;        $mid = $_GET['mid'] ? $_GET['mid'] : null;        $fm = false;        if($_GET['fmid']){            $mid = $_GET['fmid'];            $fm = true;        }        $data['imglist'] = $this->model->mpiclist($data['pages'], 'p', $p, 20, $search, $order, $tid, $tyid, $mid, $fm);        $data['title'] = '作品-'.$this->title;        if(empty($mid)){            $data['stitle'] = '格萌网-';        }else if($mid == $_SESSION['m_id']){            $data['stitle'] = '我的';        }else{            $data['stitle'] = '他的';        }        if($fm){            $data['stitle'] .= $fm?'收藏':'作品';        }else{            $data['stitle'] .= $mid?'作品':'作品';        }        $data['stitle'] .= $tid ? '-tag('.$this->model->tag_id_name($tid).')': '';        $data['stitle'] .= $search ? '-关键字('.$search.')': '';        $this->useView('top',$data);        $this->useView('index',$data);        $this->useView('bottom',$data);    }    public function pic()    {        $pid = $_GET['pid']?: $this->error_back('非法访问');        $data['pinfo'] = $this->model->picinfo($pid);        $data['prev'] = $this->model->member_pic_prev($data['pinfo']['m_id'],$pid);        $data['next'] = $this->model->member_pic_next($data['pinfo']['m_id'],$pid);        $data['pictag'] = $this->model->pic_taglist($data['pinfo']['pic_id']);        $data['mlist'] = $this->model->mmember_pic_3($data['pinfo']['m_id']);        $data['title'] = '作品-'.$data['pinfo']['pic_name'].'-'.$this->title;        $this->useView('top1',$data);        $this->useView('pic',$data);        $this->useView('bottom1');    }    public function member()    {        $mid = $_GET['mid']?: $this->error_back('非法访问');        $data['minfo'] = $this->model->member_info($mid);        $data['follownum'] = $this->model->member_follow_num($mid);        $data['fansnum'] = $this->model->member_follow_num($mid, true);        $data['imgsome'] = $this->model->member_pic_some($mid, 3);        $data['fimgsome'] = $this->model->member_pic_some($mid, 3, true);        $data['imgnum'] = $this->model->member_pic_num($mid);        $data['fimgnum'] = $this->model->member_pic_num($mid, true);        $data['title'] = $data['minfo']['m_nickname'].'-个人主页-'.$this->title;        $this->useView('top1',$data);        $this->useView('member',$data);        $this->useView('bottom1');    }    public function memberList()    {        $p = $_GET['p'] ? $_GET['p'] : 1;        $search = $_GET['search']? $_GET['search'] : null;        $gid = $_GET['gid']? $_GET['gid'] : null;        $order = $_GET['o'] ? $_GET['o'] : null;        $mid = $_GET['mid'] ? $_GET['mid'] : null;        $fm = false;        if($_GET['fmid']){            $mid = $_GET['fmid'];            $fm = true;        }        $data['title'] = '用户列表-'.$this->title;        $data['memberlist'] = $this->model->mmemberlist($data['pages'], 'p', $p, 10, $search, $gid, $order, $mid, $fm);        $this->useView('top',$data);        $this->useView('member_list',$data);        $this->useView('bottom');    }    public function followAdd()    {        $mid = $_SESSION['m_id']?: $this->error_back('请先登陆');        $fmid = $_GET['mid']?: $this->error_back('ID不能为空');        if($mid==$fmid) $this->error_back('非法操作');        if($this->model->member_follow_add($mid, $fmid)){            $this->succeed_href('关注成功');        }else{            $this->error_back('关注失败');        }    }    public function followDel()    {        $mid = $_SESSION['m_id']?: $this->error_back('请先登陆');        $fmid = $_GET['fmid']?:$this->error_back('ID为空！');        if($this->model->member_follow_is($mid, $fmid)){            if ($this->model->member_follow_del($mid, $fmid)){                $this->succeed_href('取消关注成功');            }else{                $this->error_back('取消关注失败');            }        }elseif($this->model->member_follow_is($fmid, $mid)){            if ($this->model->member_follow_del($fmid, $mid)){                $this->succeed_href('删除粉丝成功');            }else{                $this->error_back('删除粉丝失败');            }        }else{            $this->error_back('非法操作');        }    }    public function favoriteAdd()    {        $mid = $_SESSION['m_id']?: $this->error_back('请先登陆');        $pid = $_GET['pid']?: $this->error_back('ID不能为空');        if($this->model->member_favorite_add($mid, $pid)){            $this->succeed_href('收藏成功');        }else{            $this->error_back('收藏失败');        }    }    public function favoriteDel()    {        $mid = $_SESSION['m_id']?: $this->error_back('请先登陆');        $pid = $_GET['pid']?: $this->error_back('ID不能为空');        if($this->model->member_favorite_del($mid, $pid)){            $this->succeed_href('取消收藏成功');        }else{            $this->error_back('取消收藏失败');        }    }    public function tagList()    {        $p = $_GET['p'] ? $_GET['p'] : 1;        $order = $_GET['o'] ? $_GET['o'] : null;        $search = $_GET['search']? $_GET['search'] : null;        $data['title'] = '标签索引-'.$this->title;        $data['taglist'] = $this->model->tag_list($data['pages'], 'p', $p, 200, $search, $order);        $this->useView('top',$data);        $this->useView('tag_list',$data);        $this->useView('bottom');    }    public function groupList()    {        $p = $_GET['p'] ? $_GET['p'] : 1;        $search = $_GET['search']? $_GET['search'] : null;        $data['title'] = '群组列表-'.$this->title;        $data['grouplist'] = $this->model->grouplist($data['pages'], 'p', $p, 10, $search);        $this->useView('top',$data);        $this->useView('group_list',$data);        $this->useView('bottom');    }    public function group()    {        $gid = $_GET['gid']?:$this->error_back('非法访问');        $data['ginfo'] = $this->model->groupinfo($gid);        $data['mlist'] = $this->model->group_member_some($gid);        $data['title'] = $data['ginfo']['group_name'].'-'.$this->title;        $this->useView('top',$data);        $this->useView('group',$data);        $this->useView('bottom');    }    public function groupAdd()    {        $mid = $_SESSION['m_id']?:$this->error_back('请先登陆','?v=login');        if($_GET['gid']){            $gid = $_GET['gid'];        }else{            echo '非法访问';exit(0);        }        if($this->model->group_add($mid, $gid)){            echo '加入成功';exit(0);        }else{            echo '加入失败';exit(0);        }    }    public function groupDel()    {        $mid = $_SESSION['m_id']?:$this->error_back('请先登陆','?v=login');        if($_GET['gid']){            $gid = $_GET['gid'];        }else{            echo '非法访问';exit(0);        }        if($this->model->group_del($mid, $gid)){            echo '退出成功';exit(0);        }else{            echo '退出失败';exit(0);        }    }}